{% extends "base.html" %}

{% block title %}Tactics - Dashboard de Inteligencia{% endblock %}

{% block head %}
<style>
    .progress-ring__circle {
        transition: stroke-dashoffset 0.35s;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }

    .gauge-body {
        width: 100%;
        height: 0;
        padding-bottom: 50%;
        background: #f1f5f9;
        border-top-left-radius: 100% 200%;
        border-top-right-radius: 100% 200%;
        position: relative;
    }

    .gauge-fill {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        height: 100%;
        background: inherit;
        transform-origin: center top;
    }

    .animate-marquee {
        animation: marquee 25s linear infinite;
    }

    @keyframes marquee {
        0% {
            transform: translateX(0);
        }

        100% {
            transform: translateX(-50%);
        }
    }
</style>
{% endblock %}

{% block body_class %}bg-[#f8f9fa] dark:bg-gray-dark text-slate-600 dark:text-gray-400{% endblock %}

{% block content %}
<div x-data="{ sidebarToggle: false, darkMode: false, explainerModal: metricExplainer() }"
    :class="darkMode ? 'dark' : ''" class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    {% include 'partials/sidebar_app.html' %}

    <!-- Main Content Wrapper -->
    <div class="relative flex flex-1 flex-col overflow-y-auto overflow-x-hidden">
        <!-- Header -->
        {% include 'partials/header_app.html' %}

        <!-- Content Area -->
        <main class="p-6 md:p-8 lg:p-10">

            <!-- Main Insights Tab -->
            <div id="tab-insights" class="flex flex-col gap-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Premium Metric Group (TailAdmin metric-group-03) -->
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:gap-6 xl:grid-cols-3">
                        <!-- Metric Item: LTV -->
                        <div
                            class="rounded-2xl border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03] md:p-6 shadow-sm">
                            <div class="mb-6 flex items-center justify-between">
                                <div
                                    class="flex h-[48px] w-[48px] items-center justify-center rounded-xl bg-indigo-50 text-indigo-600 dark:bg-indigo-500/10 dark:text-indigo-400">
                                    <span class="material-symbols-outlined">psychology</span>
                                </div>
                                <button
                                    @click="explainerModal.explain('ltv', 'clv_12m', parseFloat(document.getElementById('ltv-value').innerText.replace(/[Ôé¼,]/g, '')))"
                                    class="p-2 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-500/10 text-indigo-600 dark:text-indigo-400 transition-all flex items-center gap-1 group">
                                    <span
                                        class="material-symbols-outlined text-[20px] group-hover:rotate-12 transition-transform">psychology</span>
                                    <span
                                        class="text-[9px] font-bold uppercase tracking-widest opacity-0 group-hover:opacity-100 transition-opacity">Explicar</span>
                                </button>
                            </div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">IA: LTV Predicho</p>
                            <div class="mt-3 flex items-end justify-between">
                                <div>
                                    <h4 class="text-2xl font-bold text-gray-800 dark:text-white/90" id="ltv-value">Ôé¼0.00
                                    </h4>
                                </div>
                                <div class="flex items-center gap-1">
                                    <span
                                        class="flex items-center gap-1 rounded-full bg-success-50 px-2 py-0.5 text-[10px] font-bold text-success-600 dark:bg-success-500/15 dark:text-success-500">
                                        +12%
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Metric Item: Churn Risk -->
                        <div
                            class="rounded-2xl border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03] md:p-6 shadow-sm">
                            <div class="mb-6 flex items-center justify-between">
                                <div
                                    class="flex h-[48px] w-[48px] items-center justify-center rounded-xl bg-red-50 text-red-600 dark:bg-red-500/10 dark:text-red-400">
                                    <span class="material-symbols-outlined">radar</span>
                                </div>
                                <button
                                    @click="explainerModal.explain('ltv', 'churn_rate', parseFloat(document.getElementById('churn-rate-value').innerText))"
                                    class="p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-500/10 text-red-600 dark:text-red-400 transition-all flex items-center gap-1 group">
                                    <span
                                        class="material-symbols-outlined text-[20px] group-hover:rotate-12 transition-transform">psychology</span>
                                    <span
                                        class="text-[9px] font-bold uppercase tracking-widest opacity-0 group-hover:opacity-100 transition-opacity">Explicar</span>
                                </button>
                            </div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Riesgo Churn Promedio
                            </p>
                            <div class="mt-3 flex items-end justify-between">
                                <div>
                                    <h4 class="text-2xl font-bold text-gray-800 dark:text-white/90"
                                        id="churn-rate-value">0%</h4>
                                </div>
                                <div class="flex items-center gap-1">
                                    <span
                                        class="flex items-center gap-1 rounded-full bg-error-50 px-2 py-0.5 text-[10px] font-bold text-error-600 dark:bg-error-500/15 dark:text-error-500">
                                        -2.4%
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Metric Item: Ad Health (MMM Index) -->
                        <div
                            class="rounded-2xl border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03] md:p-6 shadow-sm">
                            <div class="mb-6 flex items-center justify-between">
                                <div
                                    class="flex h-[48px] w-[48px] items-center justify-center rounded-xl bg-orange-50 text-orange-600 dark:bg-orange-500/10 dark:text-orange-400">
                                    <span class="material-symbols-outlined">query_stats</span>
                                </div>
                                <button @click="explainerModal.explain('mmm', 'mmm_index', 0.85)"
                                    class="p-2 rounded-lg hover:bg-orange-50 dark:hover:bg-orange-500/10 text-orange-600 dark:text-orange-400 transition-all flex items-center gap-1 group">
                                    <span
                                        class="material-symbols-outlined text-[20px] group-hover:rotate-12 transition-transform">psychology</span>
                                    <span
                                        class="text-[9px] font-bold uppercase tracking-widest opacity-0 group-hover:opacity-100 transition-opacity">Explicar</span>
                                </button>
                            </div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Salud de Inversi├│n
                                (MMM)</p>
                            <div class="mt-3 flex items-end justify-between">
                                <div>
                                    <h4 class="text-2xl font-bold text-gray-800 dark:text-white/90">SOTA</h4>
                                </div>
                                <div class="flex items-center gap-1">
                                    <span class="text-[10px] text-gray-500 dark:text-gray-400 font-medium">Bayesian
                                        Optimized</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Bayesian MMM Simulator (TailAdmin integration) -->
                        <div
                            class="lg:col-span-2 bg-gray-900 text-white p-6 rounded-2xl shadow-xl border border-gray-800 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-5">
                                <span class="material-symbols-outlined text-8xl">analytics</span>
                            </div>
                            <div class="flex items-center justify-between mb-6">
                                <h3
                                    class="font-bold text-xs flex items-center gap-2 relative z-10 uppercase tracking-widest text-brand-500 p-0">
                                    <span class="material-symbols-outlined">precision_manufacturing</span>
                                    Simulador de Presupuesto Bayesiano
                                </h3>
                                <button
                                    @click="explainerModal.explain('mmm', 'budget_allocation', parseFloat(document.getElementById('sim-budget-input').value))"
                                    class="relative z-10 p-2 rounded-xl bg-white/10 hover:bg-white/20 text-indigo-200 transition-all flex items-center gap-1 group">
                                    <span
                                        class="material-symbols-outlined text-[20px] group-hover:rotate-12 transition-transform">psychology</span>
                                    <span
                                        class="text-[9px] font-bold uppercase tracking-widest opacity-0 group-hover:opacity-100 transition-opacity">IA
                                        Insight</span>
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10">
                                <div>
                                    <label
                                        class="block text-[10px] font-bold text-gray-400 mb-2 uppercase tracking-widest">Inversi├│n
                                        Mensual Proyectada</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-3 text-brand-500 font-bold">Ôé¼</span>
                                        <input type="number" id="sim-budget-input"
                                            class="w-full bg-gray-800 border-gray-700 rounded-xl py-2.5 pl-8 text-white focus:ring-brand-500 focus:border-brand-500 transition-all font-mono text-sm"
                                            value="5000">
                                    </div>
                                    <button onclick="runSimulation()"
                                        class="mt-6 w-full bg-brand-500 hover:bg-brand-600 text-white font-bold py-3 rounded-xl transition-all flex items-center justify-center gap-2 shadow-lg shadow-brand-500/20">
                                        <span class="material-symbols-outlined text-sm">auto_awesome</span> Ejecutar
                                        Optimizaci├│n
                                    </button>
                                </div>
                                <div id="sim-results" class="bg-gray-800/50 p-5 rounded-2xl border border-gray-700/50">
                                    <p class="text-[10px] text-gray-400 uppercase font-bold mb-4 tracking-widest">
                                        Distribuci├│n Recomendada (90% CI)</p>
                                    <div class="space-y-4" id="sim-bars">
                                        <p class="text-xs text-gray-500 italic">Establezca el presupuesto y optimice
                                            para ver los rangos de confianza.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Top Traffic Source (TailAdmin module) -->
                        <div
                            class="rounded-2xl border border-gray-200 bg-white p-6 dark:border-gray-800 dark:bg-white/[0.03] shadow-sm">
                            <div class="mb-6 flex items-center justify-between">
                                <h3
                                    class="text-sm font-bold text-gray-800 dark:text-white/90 uppercase tracking-widest">
                                    Fuentes de Tr├ífico</h3>
                            </div>
                            <div class="space-y-4">
                                <div
                                    class="flex items-center justify-between border-b border-gray-50 pb-3 last:border-0 dark:border-gray-800">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center">
                                            <img src="/static/images/brand/brand-05.svg" class="w-5 h-5" alt="Google" />
                                        </div>
                                        <span class="text-xs font-bold text-gray-700 dark:text-gray-300">Google
                                            Ads</span>
                                    </div>
                                    <div class="flex items-center gap-3 w-24">
                                        <div
                                            class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden dark:bg-gray-800">
                                            <div class="bg-brand-500 h-full w-[79%]"></div>
                                        </div>
                                        <span class="text-[10px] font-bold text-gray-500">79%</span>
                                    </div>
                                </div>
                                <div
                                    class="flex items-center justify-between border-b border-gray-50 pb-3 last:border-0 dark:border-gray-800">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center">
                                            <img src="/static/images/brand/brand-02.svg" class="w-5 h-5"
                                                alt="Facebook" />
                                        </div>
                                        <span class="text-xs font-bold text-gray-700 dark:text-gray-300">Meta Ads</span>
                                    </div>
                                    <div class="flex items-center gap-3 w-24">
                                        <div
                                            class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden dark:bg-gray-800">
                                            <div class="bg-brand-500 h-full w-[48%]"></div>
                                        </div>
                                        <span class="text-[10px] font-bold text-gray-500">48%</span>
                                    </div>
                                </div>
                            </div>
                            <a href="#"
                                class="mt-6 flex items-center justify-center gap-2 rounded-xl border border-gray-200 bg-white p-2.5 text-xs font-bold text-gray-500 hover:bg-gray-50 transition-all dark:border-gray-800 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/5 uppercase tracking-widest">
                                Detalles de Atribuci├│n
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Churn Radar Table -->
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm border-l-4 border-red-500">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3
                                class="font-display font-bold text-slate-900 text-sm flex items-center gap-2 tracking-tight">
                                <span class="material-symbols-outlined text-red-500">radar</span> Radar de Fuga de VIPs
                            </h3>
                            <p class="text-[11px] text-slate-500 font-light mt-1">Clientes de alto valor con
                                probabilidad de
                                abandono superior al 70%</p>
                        </div>
                        <button onclick="exportSegments()"
                            class="text-xs font-bold bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-indigo-700 transition-all shadow-sm">
                            <span class="material-symbols-outlined text-sm">ios_share</span> Exportar a Ads/CRM
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-xs text-left">
                            <thead
                                class="bg-slate-50 text-slate-400 font-bold border-b border-slate-100 uppercase tracking-widest">
                                <tr>
                                    <th class="px-5 py-3">Cliente</th>
                                    <th class="px-5 py-3 text-center">Riesgo Churn</th>
                                    <th class="px-5 py-3">LTV Predicho (12m)</th>
                                    <th class="px-5 py-3 text-right">Acci├│n</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="churn-radar-body">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Connectors Tab (Hidden by default) -->
            <div id="tab-connectors" class="hidden flex flex-col gap-6">
                <div class="bg-white p-8 rounded-xl border border-slate-200 shadow-sm text-center max-w-2xl mx-auto">
                    <div
                        class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-6">
                        <span class="material-symbols-outlined text-3xl">hub</span>
                    </div>
                    <h3 class="text-xl font-bold text-slate-900 mb-2">Conectores de Datos</h3>
                    <p class="text-slate-500 text-sm mb-8">Administre el flujo de datos desde sus plataformas de
                        marketing y
                        e-commerce.</p>

                    <div class="grid grid-cols-1 gap-4 text-left">
                        <div class="p-4 border border-slate-100 rounded-xl flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 bg-black rounded-lg flex items-center justify-center text-white font-bold">
                                    S</div>
                                <div>
                                    <p class="text-sm font-bold text-slate-900">Shopify</p>
                                    <p class="text-[10px] text-green-600 font-bold uppercase">Conectado</p>
                                </div>
                            </div>
                            <button
                                class="text-[10px] font-bold text-slate-400 hover:text-slate-600 uppercase tracking-widest">Configurar</button>
                        </div>
                        <div class="p-4 border border-slate-100 rounded-xl flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 bg-indigo-500 rounded-lg flex items-center justify-center text-white px-2">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/0/05/Facebook_Logo_%282019%29.png"
                                        class="w-6 h-6 invert" />
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-slate-900">Meta Ads</p>
                                    <p class="text-[10px] text-green-600 font-bold uppercase">Conectado</p>
                                </div>
                            </div>
                            <button
                                class="text-[10px] font-bold text-slate-400 hover:text-slate-600 uppercase tracking-widest">Configurar</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Explainer Modal Partial -->
            {% include 'partials/explainer_modal.html' %}
        </main>
        {% endblock %}

        {% block scripts %}
        <script>
            const COMPANY_ID = "{{ company_id }}";
            const API_BASE = window.location.origin;

            async function loadDashboardData() {
                try {
                    const res = await fetch(`${API_BASE}/dashboard-data/${COMPANY_ID}`);
                    const data = await res.json();

                    if (data.metrics) {
                        document.getElementById('ltv-value').textContent = `Ôé¼${Math.round(data.metrics.ltv_total).toLocaleString()}`;
                        document.getElementById('churn-rate-value').textContent = `${(data.metrics.avg_churn * 100).toFixed(1)}%`;

                        const perc = Math.min(100, (data.metrics.ltv_total / 25000) * 100);
                        document.getElementById('ltv-perc-text').textContent = `${perc.toFixed(0)}%`;
                        const gauge = document.getElementById('ltv-gauge-path');
                        if (gauge) {
                            gauge.setAttribute('stroke-dasharray', `${perc * 2.5} 1000`);
                        }
                    }

                    const radarBody = document.getElementById('churn-radar-body');
                    if (radarBody && data.high_risk_vips) {
                        radarBody.innerHTML = '';
                        data.high_risk_vips.forEach(vip => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-slate-50 transition-colors group';
                            row.innerHTML = `
                        <td class="px-5 py-4 font-bold text-slate-900">${vip.clientes.nombre}</td>
                        <td class="px-5 py-4 text-center">
                            <span class="inline-flex items-center justify-center px-3 py-1 rounded-full bg-red-100 text-red-700 font-bold text-[10px]">
                                ${(vip.probabilidad_churn * 100).toFixed(0)}%
                            </span>
                        </td>
                        <td class="px-5 py-4 font-mono font-bold text-slate-900">Ôé¼${vip.ltv_predicho_12m.toFixed(2)}</td>
                        <td class="px-5 py-4 text-right">
                            <button class="text-indigo-600 hover:text-indigo-800 font-bold opacity-0 group-hover:opacity-100 transition-opacity uppercase tracking-widest text-[10px]">Ver An├ílisis</button>
                        </td>
                    `;
                            radarBody.appendChild(row);
                        });
                    }
                } catch (err) {
                    console.error("Dashboard Load Error:", err);
                }
            }

            async function runSimulation() {
                const btn = event.currentTarget;
                const originalHtml = btn.innerHTML;
                const budgetInput = document.getElementById('sim-budget-input');
                const budget = parseFloat(budgetInput.value);

                btn.innerHTML = '<span class="material-symbols-outlined animate-spin text-sm">sync</span> Optimizando...';
                btn.disabled = true;

                try {
                    const res = await fetch(`${API_BASE}/simulate-budget`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ company_id: COMPANY_ID, total_budget: budget })
                    });
                    const data = await res.json();

                    const simBars = document.getElementById('sim-bars');
                    simBars.innerHTML = '';

                    for (const [channel, info] of Object.entries(data.recommended_allocation)) {
                        const perc = (info.amount / budget) * 100;
                        const lowerPerc = (info.lower / budget) * 100;
                        const upperPerc = (info.upper / budget) * 100;

                        simBars.innerHTML += `
                    <div>
                        <div class="flex justify-between items-center text-[10px] mb-1.5 uppercase tracking-widest font-bold">
                            <span class="flex items-center gap-1.5 text-indigo-100">${channel} 
                                <span class="text-[9px] text-indigo-400 font-mono font-normal tracking-normal">(Ôé¼${Math.round(info.lower)} - Ôé¼${Math.round(info.upper)})</span>
                            </span>
                            <span class="text-white">Ôé¼${Math.round(info.amount).toLocaleString()}</span>
                        </div>
                        <div class="relative w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                            <div class="absolute bg-indigo-500 opacity-20 h-full" style="left: ${lowerPerc}%; width: ${Math.max(1, upperPerc - lowerPerc)}%"></div>
                            <div class="bg-indigo-400 h-full rounded-full transition-all duration-700" style="width: ${perc}%"></div>
                        </div>
                    </div>
                `;
                    }
                } catch (err) {
                    console.error("Simulation Error:", err);
                } finally {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            }

            async function triggerSync() {
                const btn = event.currentTarget;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<span class="material-symbols-outlined animate-spin text-sm">sync</span> Procesando...';
                btn.disabled = true;

                try {
                    await fetch(`${API_BASE}/sync-all`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ company_id: COMPANY_ID })
                    });
                    alert("Sincronizaci├│n iniciada. Los modelos se actualizar├ín en breve.");
                } catch (err) {
                    alert("Error de conexi├│n");
                } finally {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            }

            function switchTab(tab) {
                document.getElementById('tab-insights').classList.toggle('hidden', tab !== 'insights');
                document.getElementById('tab-connectors').classList.toggle('hidden', tab !== 'connectors');
            }

            async function exportSegments() {
                const btn = event.currentTarget;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<span class="material-symbols-outlined animate-spin text-sm">sync</span> Exportando...';
                btn.disabled = true;

                try {
                    const res = await fetch(`${API_BASE}/export-high-risk-vips`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ company_id: COMPANY_ID })
                    });
                    const data = await res.json();
                    alert(`├ëxito: Segmento de ${data.count} clientes exportado.`);
                } catch (err) {
                    alert("Error en la exportaci├│n.");
                } finally {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            }

            loadDashboardData();
        </script>

        <script type="module">
            import metricExplainer from '/static/js/components/metric-explainer.js';
            window.metricExplainer = metricExplainer;
            document.addEventListener('alpine:init', () => {
                Alpine.data('metricExplainer', metricExplainer);
            });
        </script>
        {% endblock %}
